<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Simon would have said</title>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.png" />
    <link rel="stylesheet" href="/global.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS6BJ97BPH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-YS6BJ97BPH');
    </script>
    

		

		<link rel="modulepreload" href="/./_app/start-6d421344.js">
		<link rel="modulepreload" href="/./_app/chunks/vendor-4b05f0cc.js">
		<link rel="modulepreload" href="/./_app/pages/__layout.svelte-dbd2febd.js">
		<link rel="modulepreload" href="/./_app/pages/posts/typescript-tree-traversals.mdx-ee927a15.js">
		<link rel="modulepreload" href="/./_app/chunks/blog-48540622.js">
		<link rel="stylesheet" href="/./_app/assets/start-a8cd1609.css">
		<link rel="stylesheet" href="/./_app/assets/pages/__layout.svelte-61b1aa39.css">
		<link rel="stylesheet" href="/./_app/assets/blog-5d13c88b.css">

		<script type="module">
			import { start } from "/./_app/start-6d421344.js";
			start({
				target: document.querySelector("#svelte"),
				paths: {"base":"","assets":"/."},
				session: (function(a,b){return {posts:[{title:"Static rendering in Sveltekit",date:1623753870000,status:a,blurb:"Sveltekit endpoints can shift chart rendering from runtime to compile time for more accessible websites.",slug:"static-rendering-in-sveltekit"},{title:"Type Safe URL Wrangling in React",date:1622825119000,status:a,blurb:"Search params in the URL are an underrated way to store state, but synchronizing access to them from multiple components can be tricky to type well.",slug:"type-safe-url-wrangling"},{title:"Deriving Derive Macros with Monoids",date:b,status:a,blurb:"Custom derive macros are used in a number of rust libraries to make it easy and obvious to implement some trait for structs as long as all of its fields also implement that trait.",slug:"deriving-derive-macros"},{title:"Koka vs the World",date:b,status:a,blurb:"I love statically typed functional programming. Building up programs in statically typed functional style feels like a conversation with the compiler about what is possible. Python fanatics tell me over and over that you can't prototype that way. Unfortunately, heartbreakingly, sometimes they're right.",slug:"koka-vs-the-world"},{title:"Tree Traversals in Typescript",date:b,status:a,blurb:"In a search engine, we might want to be able to slice and dice the search results that came back by three different facets; by content type, by content level, and by timeframe.",slug:"typescript-tree-traversals"},{title:"Better Pooled Coronavirus Testing",date:1598400000000,status:a,blurb:"We need to be doing more Coronavirus testing, but it is hard to scale up the number of tests we can run in a day. One way the CDC is recommending getting around this restriction is by pooling tests.",slug:"better-pooled-coronavirus-testing"}]}}("published",1618876800000)),
				host: location.host,
				route: false,
				spa: false,
				trailing_slash: "never",
				hydrate: {
					status: 200,
					error: null,
					nodes: [
						import("/./_app/pages/__layout.svelte-dbd2febd.js"),
						import("/./_app/pages/posts/typescript-tree-traversals.mdx-ee927a15.js")
					],
					page: {
						host: location.host, // TODO this is redundant
						path: "/posts/typescript-tree-traversals",
						query: new URLSearchParams(""),
						params: {}
					}
				}
			});
		</script>
  </head>
  <body>
    <div id="svelte">


<header class="svelte-1kswfwv"><a href="/" class="big svelte-1kswfwv"><h1>Simon would have said</h1></a>
  <div class="links svelte-1kswfwv"><a href="/whos-simon" class="big svelte-1kswfwv">Who&#39;s Simon?
    </a>
    <a href="/" class="small svelte-1kswfwv"><img src="/_app/assets/cottage.a5c14d1f.svg" alt="Back to index" class="svelte-1kswfwv"></a>
    <a href="https://github.com/schicks" class="svelte-1kswfwv"><img src="/_app/assets/github.6a9577cd.svg" alt="Github" style="height: 24px" class="svelte-1kswfwv"></a>
    <a href="https://www.linkedin.com/in/sam-schick-868ab8ab/" class="svelte-1kswfwv"><img src="/_app/assets/linkedin.9636faf9.svg" alt="Linkedin" style="height: 24px" class="svelte-1kswfwv"></a>
    <a href="/feed.xml" class="svelte-1kswfwv"><img src="/_app/assets/rss.5e9f88af.svg" alt="rss feed" class="svelte-1kswfwv"></a></div></header>
<div class="body svelte-1kswfwv"><article><h2>Tree Traversals in Typescript</h2>
  <p>In a search engine, we might want to be able to slice and dice the search results that came back by three different facets; by content type, by content level, and by timeframe.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// what is a facet?</span>
<span class="token keyword">type</span> <span class="token class-name">ContentType</span> <span class="token operator">=</span> <span class="token string">'videoCourse'</span> <span class="token operator">|</span> <span class="token string">'interactiveCourse'</span> <span class="token operator">|</span> <span class="token string">'project'</span>
<span class="token keyword">type</span> <span class="token class-name">Level</span> <span class="token operator">=</span> <span class="token string">'beginner'</span> <span class="token operator">|</span> <span class="token string">'intermediate'</span> <span class="token operator">|</span> <span class="token string">'advanced'</span>
<span class="token keyword">type</span> <span class="token class-name">TimeFrame</span> <span class="token operator">=</span> <span class="token string">'lastSixMonths'</span> <span class="token operator">|</span> <span class="token string">'lastYear'</span> <span class="token operator">|</span> <span class="token string">'older'</span></code></pre>
<p>When we apply a filter using one of these facets we want it to affect the counts when we are breaking down along some other facet, but not when we are looking for the counts on that facet. For example, when filtering to intermediate courses, we don’t want that filter to appear to be applied when trying to find out how many beginner courses there were, or we would just always get zero.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// what does an aggregation look like?</span>
<span class="token keyword">type</span> <span class="token class-name">EsAggregation</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  aggregations<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    contentType<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      key<span class="token operator">:</span> ContentType
      levels<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        buckets<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          key<span class="token operator">:</span> Level
          timeFrame<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            buckets<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              key<span class="token operator">:</span> TimeFrame
              doc_count<span class="token operator">:</span> <span class="token builtin">number</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>We know that down at the leaf nodes of this tree we have all of the information we need to give any of the counts we are interested in. Particularly, leaf nodes (after processing) might look something like this.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// an aspirational type. All the context we could have down at the bottom of the tree.</span>
<span class="token keyword">type</span> <span class="token class-name">Leaf</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  contentType<span class="token operator">:</span> ContentType
  level<span class="token operator">:</span> Level
  timeFrame<span class="token operator">:</span> TimeFrame
  count<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>If we can convert the elasticsearch aggregations to a flat list of leaf nodes in this form, it becomes much easier to ask questions about counts broken down by any given facet.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> flatten <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  aggregations<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    contentType<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> ctBuckets <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span>
  ctBuckets<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span>Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>ctLeafs<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> contentType<span class="token punctuation">,</span> levels<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> levelBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      levelBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>levelLeafs<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> level<span class="token punctuation">,</span> timeFrame<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> timeBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          timeBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>timeLeafs<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> timeFrame<span class="token punctuation">,</span> doc_count<span class="token operator">:</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
              <span class="token operator">...</span>timeLeafs<span class="token punctuation">,</span>
              <span class="token punctuation">&#123;</span> contentType<span class="token punctuation">,</span> level<span class="token punctuation">,</span> timeFrame<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            levelLeafs
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        ctLeafs
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span></code></pre>
<p>The idea here is that at each step down the tree, we can get the information we want from that level in context and it will be available when we get to the leaf level through closure. When we get to the leaf level, we reach up to the <code>timeBucket</code> in context for a <code>TimeFrame</code> and a <code>count</code>, the <code>levelBucket</code> in context for a <code>Level</code>, and the <code>ctBucket</code> in context for a <code>contentType</code>.</p>
<p>This process could also be seen as “denormalizing” the tree. We are taking information that is held in common by the interior nodes of the tree, and duplicating it down to every leaf node. The result is a flat structure that is much easier to iterate over, but that contains duplicate information. What if we just wanted to describe how to iterate over the structure without explicitly flattening it?</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// What context do we want from a leaf?</span>
<span class="token keyword">type</span> <span class="token class-name">Reducer<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> leaf<span class="token operator">:</span> Leaf<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span>

<span class="token comment">// How do we put the reducer in that context?</span>
<span class="token keyword">const</span> reduce <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span>
    aggregations<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      contentType<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> ctBuckets <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token operator">:</span> EsAggregation<span class="token punctuation">,</span>
  reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
  initialState<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=></span>
  ctBuckets<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>ctState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> contentType<span class="token punctuation">,</span> levels<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> levelBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      levelBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>levelState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> level<span class="token punctuation">,</span> timeFrame<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> timeBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          timeBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>timeState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> timeFrame<span class="token punctuation">,</span> doc_count<span class="token operator">:</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
              <span class="token function">reducer</span><span class="token punctuation">(</span>timeState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> timeFrame<span class="token punctuation">,</span> level<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            levelState
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        ctState
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    initialState
  <span class="token punctuation">)</span></code></pre>
<p>This is structurally the same, but now generic over which reducing operation. The type parameter here lets us tie together the initial state type, the output type, and the signature of the reducer. In fact, we can get back flatten by providing an appropriate reducer.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> flatten <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span>
  <span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span>Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>agg<span class="token punctuation">,</span> <span class="token punctuation">(</span>leafs<span class="token punctuation">,</span> leaf<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>leafs<span class="token punctuation">,</span> leaf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>What the reduce function is allowing us to do here is separate the complex logic of <em>how</em> we iterate over this structure from the comparatively simple logic of what we want to do with the result of that iteration. We have created a context in which we have all of the information we need, and the reduce function allows us to run arbitrary code within that context. Now it becomes easy to get the counts broken down by any given facet.</p>
<pre class="language-ts"><code class="language-ts"><span class="token comment">// counts broken down by a facet</span>
<span class="token keyword">type</span> <span class="token class-name">CountsBy<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token builtin">string</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>key <span class="token keyword">in</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> countsByTime <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> CountsBy<span class="token operator">&lt;</span>TimeFrame<span class="token operator">></span> <span class="token operator">=></span>
  <span class="token function">reduce</span><span class="token punctuation">(</span>
    agg<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>countsSoFar<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> timeFrame<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>countsSoFar<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>timeFrame<span class="token punctuation">]</span><span class="token operator">:</span> countsSoFar<span class="token punctuation">[</span>timeFrame<span class="token punctuation">]</span> <span class="token operator">+</span> count
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> lastSixMonths<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> lastYear<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> older<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span></code></pre>
<p>The related functions for other facets are a little trickier because our time bins overlap, which needs to be accounted for by our reducer.</p>
<pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> countsByLevel <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> CountsBy<span class="token operator">&lt;</span>Level<span class="token operator">></span> <span class="token operator">=></span>
  <span class="token function">reduce</span><span class="token punctuation">(</span>
    agg<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">countsSoFar<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> level<span class="token punctuation">,</span> timeFrame<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span>
      timeFrame <span class="token operator">===</span> <span class="token string">'older'</span>
        <span class="token operator">?</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">...</span>countsSoFar<span class="token punctuation">,</span>
            <span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token operator">:</span> countsSoFar<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">+</span> count
          <span class="token punctuation">&#125;</span>
        <span class="token operator">:</span> countsSoFar<span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> beginner<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> intermediate<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> advanced<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span></code></pre>
<p>How do we ask about the count given some set of filters? simple, we just add that filtering logic to our reducing function.</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">Filter</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  contentType<span class="token operator">:</span> ContentType<span class="token punctuation">[</span><span class="token punctuation">]</span>
  level<span class="token operator">:</span> Level<span class="token punctuation">[</span><span class="token punctuation">]</span>
  timeFrame<span class="token operator">:</span> TimeFrame<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> inFilter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> contentType<span class="token punctuation">,</span> level<span class="token punctuation">,</span> timeFrame <span class="token punctuation">&#125;</span><span class="token operator">:</span> Leaf<span class="token punctuation">,</span> filter<span class="token operator">:</span> Filter<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=></span>
  <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>contentType<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>contentType<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>level<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>level<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>timeFrame<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>timeFrame<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>timeFrame<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> filteredCountsByLevel <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">,</span> filter<span class="token operator">:</span> Filter<span class="token punctuation">)</span><span class="token operator">:</span> CountsBy<span class="token operator">&lt;</span>Level<span class="token operator">></span> <span class="token operator">=></span>
  <span class="token function">reduce</span><span class="token punctuation">(</span>
    agg<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>countsSoFar<span class="token punctuation">,</span> leaf<span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">inFilter</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>filter<span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">...</span>countsSoFar<span class="token punctuation">,</span>
            <span class="token punctuation">[</span>leaf<span class="token punctuation">.</span>level<span class="token punctuation">]</span><span class="token operator">:</span> countsSoFar<span class="token punctuation">[</span>leaf<span class="token punctuation">.</span>level<span class="token punctuation">]</span> <span class="token operator">+</span> leaf<span class="token punctuation">.</span>count
          <span class="token punctuation">&#125;</span>
        <span class="token operator">:</span> countsSoFar<span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> beginner<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> intermediate<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> advanced<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span></code></pre>
<p>Again, we separate our concerns. One function for the logic of deciding whether a leaf satisfies a filter, one function for counting up over leaves, and one function for finding the leaves we want to traverse over. Each individual function is easy to describe and therefore easy to test. Even better, they give us a vocabulary that makes their composition easy to describe; “count the items under each leaf in the tree that satisfies the filter”. Initially, setting the level in the filter to be the empty array might seem like a wart (and maybe it is, you can have your own aesthetic preferences). But it also has a nice clean interpretation; “when breaking down by level, pretend like there isn’t a level filter.”</p>
<p><a href="https://www.typescriptlang.org/play?ssl=133&ssc=2&pln=105&pc=1#code/PTAEHcAsEMBdQJYGdTVAM2gYwKawPwBQsAngA46gDCA9gHaw4MAq5lAvKAEQBuCAJjhq0ArgCckOLqAA+3BAxxjssBDxyiJU2dzJiaAKxxZYXYm1AAZHOoA2oTlwBGOAOYK6S6XK4LGYgFscfgQ4bR9ofh5oOlx+M1IKUGYEIIAxZSCHbltoJFgAZQQADwBZelhIJG8cvNgATRxoMRquGltBFsJzJIBRJABBV1cxNzgEemyAb1Rh0ddx+iQALlAZwgBILAqmWFYKVanCUBPTk6cRLABrPBW147PHk5uSVdpFFjYHp7PbGxxbHcjj8QaALtdbodvqCQS9VtY7NCYU9VOlMjgocisWDLjdYECkdiYXDkqkcBloEEADSEokg-g0LAAfW2IgYqzoIgCLjEtLpJwAvgBtAC6fKxAvFP2FYolfJl0MlAslPUo1mg6GmD22Hz2bDeO0+FBpJz+dnh-1sJtAqPJ6NWKTRlJw2pobNgHK5PMIKp1+QwuVgjDo2QAFJsptA5mNVEtDjrg3qDmtwXi7iYAEK427KgWrfpDEYxiZ0QgASgtGtFDgAfKBM9n8QA6Ub8S44AA86vQoprofDW1g3aQVNAEZJCd2+xwo7NAKBqchoDntizEPxyvLteXlrXaZbwXb-c2K+HNI2UxJK9HtopQUOi-xq1te5zkrL25fjaQB7buGPZy2me0KXjgrw2mSd4zqADLMqy7L1m6DDvtuQrQk2GFAU06AjiBk5GtB14QU61KIe6koirOlrDmWhCjiYNF0aAoq0aqoAAEqHrgYgdswdacAO+RhA6o4nthlboFu7B1sw3QgKAAASNDgDBNAQJQZAiPAlSUK27ZiIgIaVHAiGKMUBCEH68B6bg2S8VSfYRlGRYLLGdBAvhSYYim36rA265ILm+aDNGrklueNlKKsnF-kovE1ueCgIKo0C2AUsDCck5YOtu-n7pF8XHoO6VhKJF4ToaXlUXYC6+TudivhuKHSfVAKNT+kVFSuJWMOeoHgURt72j5AXPmS7Wbh+LVfgFv5HuGgFkj1M4gSSQ3OqOsEskhHpkchUl1pFYihray2jlM62kURnnTvRO0CmW1UAsttH0YUGWMK9hnJaEaUfTgrFWQGcDBkM0AKGGznBYW8yLHQFZWNh1YtQV3a9gOznnqGfwaiOO4alNdZoRsGwYU2OM4eeGwU5slGbKK5bdIklCiAwSAZiQvGgDg5lMPwKD5GICiuPxaxCi8hnJCKnrckoKqWUs8DwfiHOOhwoChlDoAFqFcMI6zKuc2rUH8YdXE4BjwxY8rSAFDQaTNOdl3QcrD3bqGRwk2TNt2w7YhU0KzvS3t+K+80geQeiIqgAA1CHmwPX1uT5EUZQVFUqwAAyznUjTNFno7tJ0Wfvt0QM2xzCIApDwzQ7rbn6zt7Oc1Xtim6AnWbJjmyhj79uO2sg2RxtIduy1J3D1k7DT6AADkRdKLPY4k-g9wk6TGF937VMbEKK7B1v4f77H8ckwKy8bH5Tdh2Ij0Ri47h0J4YgF4Z-hBCEmXZ6gUQxHEJeMzYmkBAth-Bai2JVacBpdTTgZtTS0Fo7BwOdg6SeOAGaSiBgoYBoClBhgjDdNgT0rTETtM6PMiMNRlXQCA-wqwcH+GymCGg7QmghnHj3GhuCxBNkIRQcmTBXCVAcDPTOsg5BcP8LwyBbAmwKCwLYEQggkC9xkRQMsH4ABkmjOG0KUAIuwAi6BCMgCIzgYiZASL0TwlccjYiKOUdjS0GjQDaN0dwpszsjEmLMaACxViPFePkQ4nAKjnYaMAUDSRShggG2bq3fBGwtY6xcnDah1j6HWKYXEjmXZLTt07kkq2PdD7+3xugQmGtNgbGwdYpxVC1hk2iWUlcqxRQPWqavT2XtN7X37v7apu8KYGIBAfPpfs97YRGbYaOcdhnK2qZKEmV93S236ZsO+F4H4eCin40cfglAf1CIwV+kRoixGCAAssQA" rel="nofollow">Typechecked playground demonstrating the code in this article</a></p></article>
</div>



	
</div>
  </body>
</html>
