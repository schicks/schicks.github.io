<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Simon would have said</title>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.png" />
    <link rel="stylesheet" href="/global.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS6BJ97BPH"></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())

      gtag('config', 'G-YS6BJ97BPH')
    </script>
    <meta http-equiv="content-security-policy" content="">
	<link rel="stylesheet" href="/_app/immutable/assets/pages/__layout.svelte-a075e7c9.css">
	<link rel="stylesheet" href="/_app/immutable/assets/pages/posts/pi-by-hand.mdx-3d93f555.css">
	<link rel="stylesheet" href="/_app/immutable/assets/blog-bb74b951.css">
	<link rel="modulepreload" href="/_app/immutable/start-2587346b.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-986541d7.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/preload-helper-60cab3ee.js">
	<link rel="modulepreload" href="/_app/immutable/pages/__layout.svelte-e331525b.js">
	<link rel="modulepreload" href="/_app/immutable/pages/posts/pi-by-hand.mdx-50d25a8f.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/blog-0a461edf.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/transform-56f485c3.js">
  </head>

  <body>
    <div>


<header class="svelte-18lm2j2"><a href="/" class="big svelte-18lm2j2"><h1 class="svelte-18lm2j2">Simon would have said</h1></a>
  <div class="links svelte-18lm2j2"><span class="big svelte-18lm2j2"><a href="/resume" class="svelte-18lm2j2">Resume</a></span>
    <span class="big svelte-18lm2j2"><a href="/whos-simon" class="svelte-18lm2j2">Who&#39;s Simon? </a></span>
    <span class="small svelte-18lm2j2"><a href="/" class="svelte-18lm2j2"><img src="/_app/immutable/assets/cottage-a5c14d1f.svg" alt="Back to index" class="svelte-18lm2j2"></a></span>
    <span class="svelte-18lm2j2"><a href="https://github.com/schicks" class="svelte-18lm2j2"><img src="/_app/immutable/assets/github-6a9577cd.svg" alt="Github" style="height: 24px" class="svelte-18lm2j2"></a></span>
    <span class="svelte-18lm2j2"><a href="https://www.linkedin.com/in/sam-schick-868ab8ab/" class="svelte-18lm2j2"><img src="/_app/immutable/assets/linkedin-9636faf9.svg" alt="Linkedin" style="height: 24px" class="svelte-18lm2j2"></a></span>
    <span class="svelte-18lm2j2"><a href="/feed.xml" class="svelte-18lm2j2"><img src="/_app/immutable/assets/rss-5e9f88af.svg" alt="rss feed" class="svelte-18lm2j2"></a></span></div></header>
<div class="body svelte-18lm2j2"><article class="blog"><h2>Pi By Hand</h2>
  <p>Happy Pi Day!</p>
<p>Alright, I’m a little late. I have a new kid, cut me some slack.</p>
<p>On <em>actual</em> pi day my cousin sent me a <a href="https://youtu.be/LIg-6glbLkU?si=o5g2RMM7ocy2JghO" rel="nofollow">video</a> discussing Matt Parker and friends attempt to break the world record for the most digits of pi calculated by hand. To make it possible for a big group of people to work together on the problem, they were using a <a href="https://en.wikipedia.org/wiki/Machin-like_formula" rel="nofollow">Machin-like formula</a> which breaks into 7 independent terms. This means that 7 groups of people can work independently and addd up their results at the end to get pi. </p>
<p>7 way parallelism is great, but to get to the full potential of a big group of people (they had 200 people working together on this) it seems like we want a method where we can choose the degree of parallelism to match our available resources.</p>
<p>What we are looking for is a method for calculating pi that;</p>
<ol><li>we split into arbitrarily many independent calculations</li>
<li>only involves arithmetic that is easy to do by hand</li>
<li>could reasonably get to 528 digits (breaking the current record)</li></ol>
<p>The problem made me think of an old <a href="https://github.com/apache/spark/blob/master/examples/src/main/python/pi.py" rel="nofollow">spark example</a> that calculated pi with as much parallelism as you had to throw at it. The idea was to imagine a diagram of a circle inscribed in a square.</p>
<svg viewBox="0 0 100 100" style="width: 80%; margin: 0 auto; display: block"><rect width="100" height="100" fill="blue"></rect><circle cx="50" cy="50" r="50" fill="red"></circle></svg>
<p>We know that the circle has area <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><msup><mi>r</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\pi r^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> and the square has area <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><msup><mi>r</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">4 r^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> (since the edge of the square is the diameter of the circle.) Then the ratio of the area of the circle to the square is:</p>

<p>The spark demo worked by selecting random points in the square and checking if they were also in the circle. The ratio of points in the circle to all points checked so far approximated pi. This is technically a <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method" rel="nofollow">Monte Carlo simulation</a>; the Wikipedia article even uses a diagram like the one below as an example.</p>
<p>We can do the same thing with a quarter of the diagram, since it contains both a quarter of the circle and a quarter of the square. This is convenient for a few reasons that we’ll discuss later.</p>
<svg viewBox="0 0 330 330" class="svelte-12pn6ac"><g></g></svg>
<p>Approximate value of pi: NaN</p>
<p>This seems to work, but if we want to do this by hand finding a <a href="https://hillelwayne.com/post/randomness/" rel="nofollow">random number generator that runs on your brain</a> is actually fairly hard. We certainly wouldn’t be able to calculate very precise random numbers, so (like in the diagram above), we’d end up with a “pixelated” version of the problem, which limits our precision.</p>
<p>But if we accept the pixelation for now, we can remove the randomness by just iterating over all of the pixels and checking them.</p>
<svg viewBox="0 0 330 330" class="svelte-12pn6ac"><g></g></svg>
<p>Approximate value of pi: NaN</p>
<p>This doesn’t have any parallelism because javascript is single threaded, but we could parallelize it by splitting the document into blocks and working on each block independently. So then how many pixels would we need to check to break the record?</p>
<p>We want the error of our calculation to be less than <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>528</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^-528</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">528</span></span></span></span></span></span></span></span></span></span></span></span></span>. Based on the monte carlo calculation using the formula for the standard error of a set of bernoulli trials, we get;</p>

<p>According to DuckDuckGo, that comes out to…</p>
<img alt="calculator showing the result to be infinity" style="max-width: 80%; margin: 0 auto;" src="/duckduckgo-infinity.png">
<p>Huh. Ok, that probably won’t work out for us.</p>
<p>We need to get more information out of each calculation we do. This is where using a quarter of the diagram comes in handy.</p>
<p>Think about each column of pixels. If we can find the point where the edge of the circle is, we know that every pixel below that is in the circle. So rather than check every pixel, we can go column by column and do a <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm" rel="nofollow">binary search</a> to find the last pixel within the circle.</p>
<p>Even better, because we know that the edge of the circle in the next column over is probably nearby, we can seed our binary search with that knowledge so that we will usually only need one or two checks to identify where the edge is on subsequent columns.</p>
<svg viewBox="0 0 330 330" class="svelte-12pn6ac"><g></g></svg>
<p>Approximate value of pi: NaN</p>
<p>The other advantage of this method is that we can increase the “resolution” of the diagram after we have solved it, using the work we’ve already done as a starting point. We do this by doubling the number of columns and rows, interleaving the new columns between the existing ones. Practically, this looks like adding a zero to the binary representation of every cell index. </p>
<p>On even columns (0 based), which were already in the diagram before, the new answer can only be in the cell immediately above or below the existing answer, since those are the new cells near the edge. On odd columns we can use adjacent columns to jump start our binary search, just like we did when initially filling in the diagram.</p>
<p>The arithmetic we’re talking about here is fairly simple. For the most part we are adding or subtracting, with a single square that we need to compute at each step of the binary search. Once the process is going, most of the squares will be close to ones we’ve already computed, so we can use simplifications like this <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">(n+1)^2 = n^2 + 2n + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><msup><mi>n</mi><mn>2</mn></msup><mo>−</mo><mn>2</mn><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">(n - 1)^2 = n^2 - 2n + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span>. If we’re willing to do the math in binary, multiplying by 2 (which is common in both these simplifications and in binary search itself) becomes a bit shift operation (adding or removing a digit to the little end of a number).</p>
<p>So we’ve satisfied requirements 1 and 2, but we still haven’t figured out what resolution of diagram we would need to break the record. I wrote a calculator based on the above method <a href="https://github.com/schicks/piagram" rel="nofollow">here</a> that implements the upresolution approach and reports the number of digits it got correct at each resolution.</p></article>

<script src="https://utteranc.es/client.js" repo="schicks/schicks.github.io" issue-term="Pi By Hand" label="blog-comments" theme="preferred-color-scheme" crossorigin="anonymous" async></script>
</div>


		<script type="module" data-sveltekit-hydrate="5mdzzk">
		import { start } from "/_app/immutable/start-2587346b.js";
		start({
			target: document.querySelector('[data-sveltekit-hydrate="5mdzzk"]').parentNode,
			paths: {"base":"","assets":""},
			session: (function(a,b){return {posts:[{title:"Req: Postman in the terminal",date:1655393672000,status:a,blurb:"Postman is great, but we could do better.",slug:"release-announcement-req"},{title:"Visualizing Voting Systems: Plurality vs Approval Voting",date:1623836732000,status:a,blurb:"Visualizing our voting systems can help give us a sense of how the questions each system asks shape the answers we get. By playing around with what happens depending on where candidates are relative to each other, you can get a sense of what incentives our voting system gives to the people we elect.",slug:"visualizing-voting-systems"},{title:"Static rendering in Sveltekit",date:1623753870000,status:a,blurb:"Sveltekit endpoints can shift chart rendering from runtime to compile time for more accessible websites.",slug:"static-rendering-in-sveltekit"},{title:"Type Safe URL Wrangling in React",date:1622825119000,status:a,blurb:"Search params in the URL are an underrated way to store state, but synchronizing access to them from multiple components can be tricky to type well.",slug:"type-safe-url-wrangling"},{title:"Deriving Derive Macros with Monoids",date:b,status:a,blurb:"Custom derive macros are used in a number of rust libraries to make it easy and obvious to implement some trait for structs as long as all of its fields also implement that trait.",slug:"deriving-derive-macros"},{title:"Koka vs the World",date:b,status:a,blurb:"I love statically typed functional programming. Building up programs in statically typed functional style feels like a conversation with the compiler about what is possible. Python fanatics tell me over and over that you can't prototype that way. Unfortunately, heartbreakingly, sometimes they're right.",slug:"koka-vs-the-world"},{title:"Tree Traversals in Typescript",date:b,status:a,blurb:"In a search engine, we might want to be able to slice and dice the search results that came back by three different facets; by content type, by content level, and by timeframe.",slug:"typescript-tree-traversals"},{title:"Better Pooled Coronavirus Testing",date:1598400000000,status:a,blurb:"We need to be doing more Coronavirus testing, but it is hard to scale up the number of tests we can run in a day. One way the CDC is recommending getting around this restriction is by pooling tests.",slug:"better-pooled-coronavirus-testing"}]}}("published",1618876800000)),
			route: false,
			spa: false,
			trailing_slash: "always",
			hydrate: {
				status: 200,
				error: null,
				nodes: [0, 7],
				params: {},
				routeId: "posts/pi-by-hand"
			}
		});
	</script></div>
  </body>
</html>
