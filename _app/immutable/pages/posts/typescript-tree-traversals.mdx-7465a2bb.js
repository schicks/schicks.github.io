import{S as Fa,i as xa,s as Ca,D as In,x as La,y as Sa,z as Ka,A as Pa,B as ca,r as Ya,p as Da,C as Ha,O as la,e as o,t as l,k,c as p,a as c,h as u,d as a,m as f,b as g,g as t,H as e,n as Qa}from"../../chunks/index-911407ad.js";import{B as Ga}from"../../chunks/blog-7ff63fb2.js";function Oa(K){let r,v,y,w,h=`<code class="language-ts"><span class="token comment">// what is a facet?</span>
<span class="token keyword">type</span> <span class="token class-name">ContentType</span> <span class="token operator">=</span> <span class="token string">'videoCourse'</span> <span class="token operator">|</span> <span class="token string">'interactiveCourse'</span> <span class="token operator">|</span> <span class="token string">'project'</span>
<span class="token keyword">type</span> <span class="token class-name">Level</span> <span class="token operator">=</span> <span class="token string">'beginner'</span> <span class="token operator">|</span> <span class="token string">'intermediate'</span> <span class="token operator">|</span> <span class="token string">'advanced'</span>
<span class="token keyword">type</span> <span class="token class-name">TimeFrame</span> <span class="token operator">=</span> <span class="token string">'lastSixMonths'</span> <span class="token operator">|</span> <span class="token string">'lastYear'</span> <span class="token operator">|</span> <span class="token string">'older'</span></code>`,m,b,dn,z,T,ra=`<code class="language-ts"><span class="token comment">// what does an aggregation look like?</span>
<span class="token keyword">type</span> <span class="token class-name">EsAggregation</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  aggregations<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    contentType<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      key<span class="token operator">:</span> ContentType
      levels<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        buckets<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          key<span class="token operator">:</span> Level
          timeFrame<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            buckets<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              key<span class="token operator">:</span> TimeFrame
              doc_count<span class="token operator">:</span> <span class="token builtin">number</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code>`,V,P,mn,Z,E,ia=`<code class="language-ts"><span class="token comment">// an aspirational type. All the context we could have down at the bottom of the tree.</span>
<span class="token keyword">type</span> <span class="token class-name">Leaf</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  contentType<span class="token operator">:</span> ContentType
  level<span class="token operator">:</span> Level
  timeFrame<span class="token operator">:</span> TimeFrame
  count<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">&#125;</span></code>`,X,Y,wn,$,B,ka=`<code class="language-ts"><span class="token keyword">const</span> flatten <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  aggregations<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    contentType<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> ctBuckets <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span>
  ctBuckets<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span>Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>ctLeafs<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> contentType<span class="token punctuation">,</span> levels<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> levelBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      levelBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>levelLeafs<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> level<span class="token punctuation">,</span> timeFrame<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> timeBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          timeBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>timeLeafs<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> timeFrame<span class="token punctuation">,</span> doc_count<span class="token operator">:</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
              <span class="token operator">...</span>timeLeafs<span class="token punctuation">,</span>
              <span class="token punctuation">&#123;</span> contentType<span class="token punctuation">,</span> level<span class="token punctuation">,</span> timeFrame<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            levelLeafs
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        ctLeafs
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span></code>`,nn,i,gn,j,vn,yn,I,bn,An,R,Tn,En,W,Bn,_n,q,Fn,xn,U,Cn,Ln,J,Sn,Kn,an,D,Pn,sn,_,fa=`<code class="language-ts"><span class="token comment">// What context do we want from a leaf?</span>
<span class="token keyword">type</span> <span class="token class-name">Reducer<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> leaf<span class="token operator">:</span> Leaf<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">T</span>

<span class="token comment">// How do we put the reducer in that context?</span>
<span class="token keyword">const</span> reduce <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span>
    aggregations<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      contentType<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> ctBuckets <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token operator">:</span> EsAggregation<span class="token punctuation">,</span>
  reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">,</span>
  initialState<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=></span>
  ctBuckets<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>ctState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> contentType<span class="token punctuation">,</span> levels<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> levelBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      levelBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>levelState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> level<span class="token punctuation">,</span> timeFrame<span class="token operator">:</span> <span class="token punctuation">&#123;</span> buckets<span class="token operator">:</span> timeBuckets <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          timeBuckets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>timeState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> key<span class="token operator">:</span> timeFrame<span class="token punctuation">,</span> doc_count<span class="token operator">:</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
              <span class="token function">reducer</span><span class="token punctuation">(</span>timeState<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> timeFrame<span class="token punctuation">,</span> level<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            levelState
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        ctState
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    initialState
  <span class="token punctuation">)</span></code>`,tn,H,Yn,en,F,ha=`<code class="language-ts"><span class="token keyword">const</span> flatten <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=></span>
  <span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span>Leaf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>agg<span class="token punctuation">,</span> <span class="token punctuation">(</span>leafs<span class="token punctuation">,</span> leaf<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>leafs<span class="token punctuation">,</span> leaf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code>`,on,A,Dn,N,Hn,Qn,pn,x,da=`<code class="language-ts"><span class="token comment">// counts broken down by a facet</span>
<span class="token keyword">type</span> <span class="token class-name">CountsBy<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token builtin">string</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>key <span class="token keyword">in</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> countsByTime <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> CountsBy<span class="token operator">&lt;</span>TimeFrame<span class="token operator">></span> <span class="token operator">=></span>
  <span class="token function">reduce</span><span class="token punctuation">(</span>
    agg<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>countsSoFar<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> timeFrame<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>countsSoFar<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>timeFrame<span class="token punctuation">]</span><span class="token operator">:</span> countsSoFar<span class="token punctuation">[</span>timeFrame<span class="token punctuation">]</span> <span class="token operator">+</span> count
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> lastSixMonths<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> lastYear<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> older<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span></code>`,cn,Q,Gn,ln,C,ma=`<code class="language-tsx"><span class="token keyword">const</span> countsByLevel <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">)</span><span class="token operator">:</span> CountsBy<span class="token operator">&lt;</span>Level<span class="token operator">></span> <span class="token operator">=></span>
  <span class="token function">reduce</span><span class="token punctuation">(</span>
    agg<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>countsSoFar<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> level<span class="token punctuation">,</span> timeFrame<span class="token punctuation">,</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      timeFrame <span class="token operator">===</span> <span class="token string">'older'</span>
        <span class="token operator">?</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">...</span>countsSoFar<span class="token punctuation">,</span>
            <span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token operator">:</span> countsSoFar<span class="token punctuation">[</span>level<span class="token punctuation">]</span> <span class="token operator">+</span> count
          <span class="token punctuation">&#125;</span>
        <span class="token operator">:</span> countsSoFar<span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> beginner<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> intermediate<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> advanced<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span></code>`,un,G,On,rn,L,wa=`<code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">Filter</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  contentType<span class="token operator">:</span> ContentType<span class="token punctuation">[</span><span class="token punctuation">]</span>
  level<span class="token operator">:</span> Level<span class="token punctuation">[</span><span class="token punctuation">]</span>
  timeFrame<span class="token operator">:</span> TimeFrame<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> inFilter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> contentType<span class="token punctuation">,</span> level<span class="token punctuation">,</span> timeFrame <span class="token punctuation">&#125;</span><span class="token operator">:</span> Leaf<span class="token punctuation">,</span> filter<span class="token operator">:</span> Filter<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=></span>
  <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>contentType<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>contentType<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>level<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>level<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>timeFrame<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> filter<span class="token punctuation">.</span>timeFrame<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>timeFrame<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> filteredCountsByLevel <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token operator">:</span> EsAggregation<span class="token punctuation">,</span> filter<span class="token operator">:</span> Filter<span class="token punctuation">)</span><span class="token operator">:</span> CountsBy<span class="token operator">&lt;</span>Level<span class="token operator">></span> <span class="token operator">=></span>
  <span class="token function">reduce</span><span class="token punctuation">(</span>
    agg<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>countsSoFar<span class="token punctuation">,</span> leaf<span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">inFilter</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>filter<span class="token punctuation">,</span> level<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">...</span>countsSoFar<span class="token punctuation">,</span>
            <span class="token punctuation">[</span>leaf<span class="token punctuation">.</span>level<span class="token punctuation">]</span><span class="token operator">:</span> countsSoFar<span class="token punctuation">[</span>leaf<span class="token punctuation">.</span>level<span class="token punctuation">]</span> <span class="token operator">+</span> leaf<span class="token punctuation">.</span>count
          <span class="token punctuation">&#125;</span>
        <span class="token operator">:</span> countsSoFar<span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> beginner<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> intermediate<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> advanced<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span></code>`,kn,O,Mn,fn,M,S,jn;return{c(){r=o("p"),v=l("In a search engine, we might want to be able to slice and dice the search results that came back by three different facets; by content type, by content level, and by timeframe."),y=k(),w=o("pre"),m=k(),b=o("p"),dn=l("When we apply a filter using one of these facets we want it to affect the counts when we are breaking down along some other facet, but not when we are looking for the counts on that facet. For example, when filtering to intermediate courses, we don\u2019t want that filter to appear to be applied when trying to find out how many beginner courses there were, or we would just always get zero."),z=k(),T=o("pre"),V=k(),P=o("p"),mn=l("We know that down at the leaf nodes of this tree we have all of the information we need to give any of the counts we are interested in. Particularly, leaf nodes (after processing) might look something like this."),Z=k(),E=o("pre"),X=k(),Y=o("p"),wn=l("If we can convert the elasticsearch aggregations to a flat list of leaf nodes in this form, it becomes much easier to ask questions about counts broken down by any given facet."),$=k(),B=o("pre"),nn=k(),i=o("p"),gn=l("The idea here is that at each step down the tree, we can get the information we want from that level in context and it will be available when we get to the leaf level through closure. When we get to the leaf level, we reach up to the "),j=o("code"),vn=l("timeBucket"),yn=l(" in context for a "),I=o("code"),bn=l("TimeFrame"),An=l(" and a "),R=o("code"),Tn=l("count"),En=l(", the "),W=o("code"),Bn=l("levelBucket"),_n=l(" in context for a "),q=o("code"),Fn=l("Level"),xn=l(", and the "),U=o("code"),Cn=l("ctBucket"),Ln=l(" in context for a "),J=o("code"),Sn=l("contentType"),Kn=l("."),an=k(),D=o("p"),Pn=l("This process could also be seen as \u201Cdenormalizing\u201D the tree. We are taking information that is held in common by the interior nodes of the tree, and duplicating it down to every leaf node. The result is a flat structure that is much easier to iterate over, but that contains duplicate information. What if we just wanted to describe how to iterate over the structure without explicitly flattening it?"),sn=k(),_=o("pre"),tn=k(),H=o("p"),Yn=l("This is structurally the same, but now generic over which reducing operation. The type parameter here lets us tie together the initial state type, the output type, and the signature of the reducer. In fact, we can get back flatten by providing an appropriate reducer."),en=k(),F=o("pre"),on=k(),A=o("p"),Dn=l("What the reduce function is allowing us to do here is separate the complex logic of "),N=o("em"),Hn=l("how"),Qn=l(" we iterate over this structure from the comparatively simple logic of what we want to do with the result of that iteration. We have created a context in which we have all of the information we need, and the reduce function allows us to run arbitrary code within that context. Now it becomes easy to get the counts broken down by any given facet."),pn=k(),x=o("pre"),cn=k(),Q=o("p"),Gn=l("The related functions for other facets are a little trickier because our time bins overlap, which needs to be accounted for by our reducer."),ln=k(),C=o("pre"),un=k(),G=o("p"),On=l("How do we ask about the count given some set of filters? simple, we just add that filtering logic to our reducing function."),rn=k(),L=o("pre"),kn=k(),O=o("p"),Mn=l("Again, we separate our concerns. One function for the logic of deciding whether a leaf satisfies a filter, one function for counting up over leaves, and one function for finding the leaves we want to traverse over. Each individual function is easy to describe and therefore easy to test. Even better, they give us a vocabulary that makes their composition easy to describe; \u201Ccount the items under each leaf in the tree that satisfies the filter\u201D. Initially, setting the level in the filter to be the empty array might seem like a wart (and maybe it is, you can have your own aesthetic preferences). But it also has a nice clean interpretation; \u201Cwhen breaking down by level, pretend like there isn\u2019t a level filter.\u201D"),fn=k(),M=o("p"),S=o("a"),jn=l("Typechecked playground demonstrating the code in this article"),this.h()},l(n){r=p(n,"P",{});var s=c(r);v=u(s,"In a search engine, we might want to be able to slice and dice the search results that came back by three different facets; by content type, by content level, and by timeframe."),s.forEach(a),y=f(n),w=p(n,"PRE",{class:!0});var ga=c(w);ga.forEach(a),m=f(n),b=p(n,"P",{});var Rn=c(b);dn=u(Rn,"When we apply a filter using one of these facets we want it to affect the counts when we are breaking down along some other facet, but not when we are looking for the counts on that facet. For example, when filtering to intermediate courses, we don\u2019t want that filter to appear to be applied when trying to find out how many beginner courses there were, or we would just always get zero."),Rn.forEach(a),z=f(n),T=p(n,"PRE",{class:!0});var va=c(T);va.forEach(a),V=f(n),P=p(n,"P",{});var Wn=c(P);mn=u(Wn,"We know that down at the leaf nodes of this tree we have all of the information we need to give any of the counts we are interested in. Particularly, leaf nodes (after processing) might look something like this."),Wn.forEach(a),Z=f(n),E=p(n,"PRE",{class:!0});var ya=c(E);ya.forEach(a),X=f(n),Y=p(n,"P",{});var qn=c(Y);wn=u(qn,"If we can convert the elasticsearch aggregations to a flat list of leaf nodes in this form, it becomes much easier to ask questions about counts broken down by any given facet."),qn.forEach(a),$=f(n),B=p(n,"PRE",{class:!0});var ba=c(B);ba.forEach(a),nn=f(n),i=p(n,"P",{});var d=c(i);gn=u(d,"The idea here is that at each step down the tree, we can get the information we want from that level in context and it will be available when we get to the leaf level through closure. When we get to the leaf level, we reach up to the "),j=p(d,"CODE",{});var Un=c(j);vn=u(Un,"timeBucket"),Un.forEach(a),yn=u(d," in context for a "),I=p(d,"CODE",{});var Jn=c(I);bn=u(Jn,"TimeFrame"),Jn.forEach(a),An=u(d," and a "),R=p(d,"CODE",{});var Nn=c(R);Tn=u(Nn,"count"),Nn.forEach(a),En=u(d,", the "),W=p(d,"CODE",{});var zn=c(W);Bn=u(zn,"levelBucket"),zn.forEach(a),_n=u(d," in context for a "),q=p(d,"CODE",{});var Vn=c(q);Fn=u(Vn,"Level"),Vn.forEach(a),xn=u(d,", and the "),U=p(d,"CODE",{});var Zn=c(U);Cn=u(Zn,"ctBucket"),Zn.forEach(a),Ln=u(d," in context for a "),J=p(d,"CODE",{});var Xn=c(J);Sn=u(Xn,"contentType"),Xn.forEach(a),Kn=u(d,"."),d.forEach(a),an=f(n),D=p(n,"P",{});var $n=c(D);Pn=u($n,"This process could also be seen as \u201Cdenormalizing\u201D the tree. We are taking information that is held in common by the interior nodes of the tree, and duplicating it down to every leaf node. The result is a flat structure that is much easier to iterate over, but that contains duplicate information. What if we just wanted to describe how to iterate over the structure without explicitly flattening it?"),$n.forEach(a),sn=f(n),_=p(n,"PRE",{class:!0});var Aa=c(_);Aa.forEach(a),tn=f(n),H=p(n,"P",{});var na=c(H);Yn=u(na,"This is structurally the same, but now generic over which reducing operation. The type parameter here lets us tie together the initial state type, the output type, and the signature of the reducer. In fact, we can get back flatten by providing an appropriate reducer."),na.forEach(a),en=f(n),F=p(n,"PRE",{class:!0});var Ta=c(F);Ta.forEach(a),on=f(n),A=p(n,"P",{});var hn=c(A);Dn=u(hn,"What the reduce function is allowing us to do here is separate the complex logic of "),N=p(hn,"EM",{});var aa=c(N);Hn=u(aa,"how"),aa.forEach(a),Qn=u(hn," we iterate over this structure from the comparatively simple logic of what we want to do with the result of that iteration. We have created a context in which we have all of the information we need, and the reduce function allows us to run arbitrary code within that context. Now it becomes easy to get the counts broken down by any given facet."),hn.forEach(a),pn=f(n),x=p(n,"PRE",{class:!0});var Ea=c(x);Ea.forEach(a),cn=f(n),Q=p(n,"P",{});var sa=c(Q);Gn=u(sa,"The related functions for other facets are a little trickier because our time bins overlap, which needs to be accounted for by our reducer."),sa.forEach(a),ln=f(n),C=p(n,"PRE",{class:!0});var Ba=c(C);Ba.forEach(a),un=f(n),G=p(n,"P",{});var ta=c(G);On=u(ta,"How do we ask about the count given some set of filters? simple, we just add that filtering logic to our reducing function."),ta.forEach(a),rn=f(n),L=p(n,"PRE",{class:!0});var _a=c(L);_a.forEach(a),kn=f(n),O=p(n,"P",{});var ea=c(O);Mn=u(ea,"Again, we separate our concerns. One function for the logic of deciding whether a leaf satisfies a filter, one function for counting up over leaves, and one function for finding the leaves we want to traverse over. Each individual function is easy to describe and therefore easy to test. Even better, they give us a vocabulary that makes their composition easy to describe; \u201Ccount the items under each leaf in the tree that satisfies the filter\u201D. Initially, setting the level in the filter to be the empty array might seem like a wart (and maybe it is, you can have your own aesthetic preferences). But it also has a nice clean interpretation; \u201Cwhen breaking down by level, pretend like there isn\u2019t a level filter.\u201D"),ea.forEach(a),fn=f(n),M=p(n,"P",{});var oa=c(M);S=p(oa,"A",{href:!0,rel:!0});var pa=c(S);jn=u(pa,"Typechecked playground demonstrating the code in this article"),pa.forEach(a),oa.forEach(a),this.h()},h(){g(w,"class","language-ts"),g(T,"class","language-ts"),g(E,"class","language-ts"),g(B,"class","language-ts"),g(_,"class","language-ts"),g(F,"class","language-ts"),g(x,"class","language-ts"),g(C,"class","language-tsx"),g(L,"class","language-ts"),g(S,"href","https://www.typescriptlang.org/play?ssl=133&ssc=2&pln=105&pc=1#code/PTAEHcAsEMBdQJYGdTVAM2gYwKawPwBQsAngA46gDCA9gHaw4MAq5lAvKAEQBuCAJjhq0ArgCckOLqAA+3BAxxjssBDxyiJU2dzJiaAKxxZYXYm1AAZHOoA2oTlwBGOAOYK6S6XK4LGYgFscfgQ4bR9ofh5oOlx+M1IKUGYEIIAxZSCHbltoJFgAZQQADwBZelhIJG8cvNgATRxoMRquGltBFsJzJIBRJABBV1cxNzgEemyAb1Rh0ddx+iQALlAZwgBILAqmWFYKVanCUBPTk6cRLABrPBW147PHk5uSVdpFFjYHp7PbGxxbHcjj8QaALtdbodvqCQS9VtY7NCYU9VOlMjgocisWDLjdYECkdiYXDkqkcBloEEADSEokg-g0LAAfW2IgYqzoIgCLjEtLpJwAvgBtAC6fKxAvFP2FYolfJl0MlAslPUo1mg6GmD22Hz2bDeO0+FBpJz+dnh-1sJtAqPJ6NWKTRlJw2pobNgHK5PMIKp1+QwuVgjDo2QAFJsptA5mNVEtDjrg3qDmtwXi7iYAEK427KgWrfpDEYxiZ0QgASgtGtFDgAfKBM9n8QA6Ub8S44AA86vQoprofDW1g3aQVNAEZJCd2+xwo7NAKBqchoDntizEPxyvLteXlrXaZbwXb-c2K+HNI2UxJK9HtopQUOi-xq1te5zkrL25fjaQB7buGPZy2me0KXjgrw2mSd4zqADLMqy7L1m6DDvtuQrQk2GFAU06AjiBk5GtB14QU61KIe6koirOlrDmWhCjiYNF0aAoq0aqoAAEqHrgYgdswdacAO+RhA6o4nthlboFu7B1sw3QgKAAASNDgDBNAQJQZAiPAlSUK27ZiIgIaVHAiGKMUBCEH68B6bg2S8VSfYRlGRYLLGdBAvhSYYim36rA265ILm+aDNGrklueNlKKsnF-kovE1ueCgIKo0C2AUsDCck5YOtu-n7pF8XHoO6VhKJF4ToaXlUXYC6+TudivhuKHSfVAKNT+kVFSuJWMOeoHgURt72j5AXPmS7Wbh+LVfgFv5HuGgFkj1M4gSSQ3OqOsEskhHpkchUl1pFYihray2jlM62kURnnTvRO0CmW1UAsttH0YUGWMK9hnJaEaUfTgrFWQGcDBkM0AKGGznBYW8yLHQFZWNh1YtQV3a9gOznnqGfwaiOO4alNdZoRsGwYU2OM4eeGwU5slGbKK5bdIklCiAwSAZiQvGgDg5lMPwKD5GICiuPxaxCi8hnJCKnrckoKqWUs8DwfiHOOhwoChlDoAFqFcMI6zKuc2rUH8YdXE4BjwxY8rSAFDQaTNOdl3QcrD3bqGRwk2TNt2w7YhU0KzvS3t+K+80geQeiIqgAA1CHmwPX1uT5EUZQVFUqwAAyznUjTNFno7tJ0Wfvt0QM2xzCIApDwzQ7rbn6zt7Oc1Xtim6AnWbJjmyhj79uO2sg2RxtIduy1J3D1k7DT6AADkRdKLPY4k-g9wk6TGF937VMbEKK7B1v4f77H8ckwKy8bH5Tdh2Ij0Ri47h0J4YgF4Z-hBCEmXZ6gUQxHEJeMzYmkBAth-Bai2JVacBpdTTgZtTS0Fo7BwOdg6SeOAGaSiBgoYBoClBhgjDdNgT0rTETtM6PMiMNRlXQCA-wqwcH+GymCGg7QmghnHj3GhuCxBNkIRQcmTBXCVAcDPTOsg5BcP8LwyBbAmwKCwLYEQggkC9xkRQMsH4ABkmjOG0KUAIuwAi6BCMgCIzgYiZASL0TwlccjYiKOUdjS0GjQDaN0dwpszsjEmLMaACxViPFePkQ4nAKjnYaMAUDSRShggG2bq3fBGwtY6xcnDah1j6HWKYXEjmXZLTt07kkq2PdD7+3xugQmGtNgbGwdYpxVC1hk2iWUlcqxRQPWqavT2XtN7X37v7apu8KYGIBAfPpfs97YRGbYaOcdhnK2qZKEmV93S236ZsO+F4H4eCin40cfglAf1CIwV+kRoixGCAAssQA"),g(S,"rel","nofollow")},m(n,s){t(n,r,s),e(r,v),t(n,y,s),t(n,w,s),w.innerHTML=h,t(n,m,s),t(n,b,s),e(b,dn),t(n,z,s),t(n,T,s),T.innerHTML=ra,t(n,V,s),t(n,P,s),e(P,mn),t(n,Z,s),t(n,E,s),E.innerHTML=ia,t(n,X,s),t(n,Y,s),e(Y,wn),t(n,$,s),t(n,B,s),B.innerHTML=ka,t(n,nn,s),t(n,i,s),e(i,gn),e(i,j),e(j,vn),e(i,yn),e(i,I),e(I,bn),e(i,An),e(i,R),e(R,Tn),e(i,En),e(i,W),e(W,Bn),e(i,_n),e(i,q),e(q,Fn),e(i,xn),e(i,U),e(U,Cn),e(i,Ln),e(i,J),e(J,Sn),e(i,Kn),t(n,an,s),t(n,D,s),e(D,Pn),t(n,sn,s),t(n,_,s),_.innerHTML=fa,t(n,tn,s),t(n,H,s),e(H,Yn),t(n,en,s),t(n,F,s),F.innerHTML=ha,t(n,on,s),t(n,A,s),e(A,Dn),e(A,N),e(N,Hn),e(A,Qn),t(n,pn,s),t(n,x,s),x.innerHTML=da,t(n,cn,s),t(n,Q,s),e(Q,Gn),t(n,ln,s),t(n,C,s),C.innerHTML=ma,t(n,un,s),t(n,G,s),e(G,On),t(n,rn,s),t(n,L,s),L.innerHTML=wa,t(n,kn,s),t(n,O,s),e(O,Mn),t(n,fn,s),t(n,M,s),e(M,S),e(S,jn)},p:Qa,d(n){n&&a(r),n&&a(y),n&&a(w),n&&a(m),n&&a(b),n&&a(z),n&&a(T),n&&a(V),n&&a(P),n&&a(Z),n&&a(E),n&&a(X),n&&a(Y),n&&a($),n&&a(B),n&&a(nn),n&&a(i),n&&a(an),n&&a(D),n&&a(sn),n&&a(_),n&&a(tn),n&&a(H),n&&a(en),n&&a(F),n&&a(on),n&&a(A),n&&a(pn),n&&a(x),n&&a(cn),n&&a(Q),n&&a(ln),n&&a(C),n&&a(un),n&&a(G),n&&a(rn),n&&a(L),n&&a(kn),n&&a(O),n&&a(fn),n&&a(M)}}}function Ma(K){let r,v;const y=[K[0],ua];let w={$$slots:{default:[Oa]},$$scope:{ctx:K}};for(let h=0;h<y.length;h+=1)w=In(w,y[h]);return r=new Ga({props:w}),{c(){La(r.$$.fragment)},l(h){Sa(r.$$.fragment,h)},m(h,m){Ka(r,h,m),v=!0},p(h,[m]){const b=m&1?Pa(y,[m&1&&ca(h[0]),m&0&&ca(ua)]):{};m&2&&(b.$$scope={dirty:m,ctx:h}),r.$set(b)},i(h){v||(Ya(r.$$.fragment,h),v=!0)},o(h){Da(r.$$.fragment,h),v=!1},d(h){Ha(r,h)}}}const ua={title:"Tree Traversals in Typescript",date:"2021-04-20T00:00:00.000Z",status:"published",blurb:"In a search engine, we might want to be able to slice and dice the search results that came back by three different facets; by content type, by content level, and by timeframe."};function ja(K,r,v){return K.$$set=y=>{v(0,r=In(In({},r),la(y)))},r=la(r),[r]}class Wa extends Fa{constructor(r){super(),xa(this,r,ja,Ma,Ca,{})}}export{Wa as default,ua as metadata};
